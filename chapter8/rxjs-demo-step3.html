<!DOCTYPE html>
<html lang="zh-cn">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>8.Rxjs è€äººä¸æµ·</title>
    <link rel="stylesheet" href="style.css">
    <script src="https://cdn.bootcdn.net/ajax/libs/rxjs/6.6.3/rxjs.umd.min.js"></script>
</head>

<body>
    <h3>rxjså®ç°ToDoList</h3>
    <p>STEP3â€”â€”ç‚¹å‡»å®Œæˆå¾…åŠé¡¹ï¼ˆäº‹ä»¶ä»£ç†æ–¹å¼ï¼‰</p>
    <div>
        <input id="user-input" type="text" />
        <a id="btn-add" class="btn">Add</a>
    </div>
    <ul id="list" class="list"></ul>
    <script>
        const { filter, tap, map, flatMap, mapTo } = rxjs.operators;
        const { merge } = rxjs;

        const $input = document.querySelector("#user-input");
        const $btn = document.querySelector("#btn-add");
        const $list = document.querySelector("#list");

        //æ–°å¢å¾…åŠäº‹é¡¹
        const addItem = (content) => {
            let li = document.createElement("li");
            li.classList.add("todo-item");
            li.innerHTML = `<span>${content}</span><a class="btn btn-finish">&Omicron;</a>`;
            return li;
        };

        //é”®ç›˜å›è½¦é”®æ•°æ®æµ
        const inputEnter$ = rxjs.fromEvent($input, "keydown").pipe(filter(r => r.keyCode === 13));
        //é¼ æ ‡ç‚¹å‡»æŒ‰é’®æ•°æ®æµæµ
        const click$ = rxjs.fromEvent($btn, "click");
        //æ·»åŠ æ–°çš„å¾…åŠé¡¹
        const addtodo$ = merge(inputEnter$, click$).pipe(
            map(()=>$input.value), //æ˜ å°„ä¸ºç›®æ ‡å€¼
            filter((r) => r !== ""), //è¿‡æ»¤
            map(addItem), //æ˜ å°„
            tap((li) => { //å‰¯ä½œç”¨ç®¡ç†
                const $ul = document.querySelector(".list");
                $ul.appendChild(li);
                $input.value = '';
            })
        );

        //åœ¨åˆ—è¡¨æ ‡ç­¾ä¸Šè¿›è¡Œäº‹ä»¶ä»£ç†
        const clickList$ = rxjs.fromEvent($list, 'click')
            .pipe(
                map(e => e.target),
                tap(ele => {
                    if (ele.tagName.toLowerCase() === 'a') {
                        ele.innerHTML = "ğŸ†",
                        ele.parentNode.classList.add('todo-item--done');
                    }
                })
            )

        const app$ = merge(addtodo$, clickList$);

        app$.subscribe(); 
    </script>
</body>

</html>