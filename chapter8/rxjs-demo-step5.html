<!DOCTYPE html>
<html lang="zh-cn">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>8.Rxjs è€äººä¸æµ·</title>
  <link rel="stylesheet" href="style.css" />
  <script src="https://cdn.bootcdn.net/ajax/libs/rxjs/6.6.3/rxjs.umd.min.js"></script>
  <script src="http.js"></script>
</head>

<body>
  <h3>rxjså®ç°ToDoList</h3>
  <p>STEP5â€”â€”å‡½æ•°å»æŠ–åå‘æœåŠ¡ç«¯æäº¤</p>
  <div>
    <input id="user-input" type="text" />
    <a id="btn-add" class="btn">Add</a>
  </div>
  <ul id="list" class="list"></ul>
  <script>
    const {
      filter,
      tap,
      map,
      flatMap,
      mapTo,
      switchMap,
      debounceTime,
      throttle,
    } = rxjs.operators;
    const { merge, from, of, Observable } = rxjs;

    /** 
     * è‡ªå®šä¹‰operatorï¼Œå®ç°logæ—¥å¿—åŠŸèƒ½
     */
    const log = key => source => {
      return Observable.create((subscriber) => {
        var subscription = source.subscribe(
          (value) => {
            try {
              console.log(`ã€Logã€‘${key}:${value}`)
              subscriber.next(value);
            } catch (err) {
              subscriber.error(err);
            }
          },
          (err) => subscriber.error(err),
          () => subscriber.complete()
        );

        return subscription;
      });
    };

    const $input = document.querySelector("#user-input");
    const $btn = document.querySelector("#btn-add");
    const $list = document.querySelector("#list");

    //æ–°å¢å¾…åŠäº‹é¡¹
    const addItem = (content) => {
      let li = document.createElement("li");
      li.classList.add("todo-item");
      li.innerHTML = `<span>${content}</span><a class="btn btn-finish">&Omicron;</a >`;
      return li;
    };
    //å­—ç¬¦æµ
    const input$ = rxjs.fromEvent($input, "keydown");
    //é”®ç›˜å›è½¦é”®æ•°æ®æµ
    const inputEnter$ = input$.pipe(filter((r) => r.keyCode === 13));
    //é¼ æ ‡ç‚¹å‡»æŒ‰é’®æ•°æ®æµæµ
    const click$ = rxjs.fromEvent($btn, "click");

    //æ·»åŠ æ–°çš„å¾…åŠé¡¹
    const addtodo$ = merge(inputEnter$, click$).pipe(
      map(() => $input.value), //æ˜ å°„ä¸ºç›®æ ‡å€¼
      filter((r) => r !== ""), //è¿‡æ»¤
      log('before debounce'),
      debounceTime(500), //å»æŠ–
      log('before request'),
      switchMap((r) => from(http.post(r))), //switchMapæ‹å¹³ä¼šä¸¢å¼ƒå‰ä¸€ä¸ªå€¼è€Œåªä¿ç•™æœ€æ–°å€¼
      //flatMap((r) => from(http.post(r))), //flatMapæ‰å¹³åŒ–ä¼šä¿ç•™æ‰€æœ‰å€¼
      map((r) => { //å¯¹æ¯”switchMapå’ŒflatMap
        console.log('æ”¶åˆ°æœåŠ¡ç«¯å“åº”:',r);
        return r.val;
      }),
      map(addItem), //æ˜ å°„
      tap((li) => { //å‰¯ä½œç”¨ç®¡ç†
        const $ul = document.querySelector(".list");
        $ul.appendChild(li);
        $input.value = "";
      })
    );

    //åœ¨åˆ—è¡¨æ ‡ç­¾ä¸Šè¿›è¡Œäº‹ä»¶ä»£ç†
    const clickList$ = rxjs.fromEvent($list, "click").pipe(
      map((e) => e.target),
      tap((ele) => {
        if (ele.tagName.toLowerCase() === "a") {
          (ele.innerHTML = "ğŸ†"),
            ele.parentNode.classList.add("todo-item--done");
        }
      })
    );

    const app$ = merge(addtodo$, clickList$);

    app$.subscribe();
  </script>
</body>

</html>